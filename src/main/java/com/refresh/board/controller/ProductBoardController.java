package com.refresh.board.controller;

import java.io.IOException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.List;
import java.util.Map;
import java.util.concurrent.TimeUnit;
import java.util.stream.Collectors;
import java.util.HashMap;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.core.type.TypeReference;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.CacheControl;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.util.InvalidMimeTypeException;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

import java.sql.Timestamp;

import com.refresh.board.dao.PBoardDAO;
import com.refresh.board.service.PBoardService;
import com.refresh.board.vo.CartItem;
import com.refresh.board.vo.OrderVO;
import com.refresh.board.vo.PReviewVO;
import com.refresh.board.vo.ProductBoardVO;
import com.refresh.board.vo.ProductImageVO;
import com.refresh.board.vo.ReviewImageVO;
import com.refresh.member.service.MemberService;
import com.refresh.member.vo.MemberBenefit;
import com.refresh.member.vo.MemberVO;
import com.refresh.menu.service.MenuService;
import com.refresh.menu.vo.MenuVO;

import jakarta.servlet.http.HttpSession;

@Controller
@RequestMapping("/products")
public class ProductBoardController {

    @Autowired
    private final PBoardService productService;
    private final PBoardDAO pBoardDAO;
    private final MenuService menuService;
    private final MemberService memberService;

    public ProductBoardController(MenuService menuService, MemberService memberService,
    		PBoardService productService, PBoardDAO pBoardDAO) {
        this.menuService = menuService;
        this.memberService = memberService;
        this.productService = productService;
        this.pBoardDAO = pBoardDAO;
    }
    
    // Î°úÍ∑∏Ïù∏ Ï†Ñ Î¶¨Ïä§Ìä∏
    @GetMapping
    public String productBoard(@RequestParam(value = "category", required = false) String category,
                               @RequestParam(value = "page", defaultValue = "1") int page,
                               Model model) {

        List<MenuVO> sidebarMenus = menuService.getMenusByPosition("sidebar");
        List<MenuVO> headerMenus = menuService.getMenusByPosition("header");
        List<MenuVO> menus = menuService.getAllMenus();
        model.addAttribute("menus", menus);
        model.addAttribute("sidebarMenus", sidebarMenus);
        model.addAttribute("headerMenus", headerMenus);
        
        if (category != null && !category.isEmpty()) {
            int pageSize = 40; // 5 x 8 Ïπ¥Îìú Í∏∞Ï§Ä
            int offset = (page - 1) * pageSize;

            List<ProductBoardVO> products = menuService.getProductsByCategoryPaged(category, offset, pageSize);
            int totalCount = menuService.countProductsByCategory(category);
            int totalPages = (int) Math.ceil((double) totalCount / pageSize);

            model.addAttribute("products", products);
            model.addAttribute("selectedCategory", category);
            model.addAttribute("currentPage", page);
            model.addAttribute("totalPages", totalPages);
        } else {
            model.addAttribute("products", Collections.emptyList());
        }

        return "refresh/productboard";
    }
    
    // Î°úÍ∑∏Ïù∏ ÌõÑ Î¶¨Ïä§Ìä∏
    @GetMapping("/login")
    public String productBoardLogin(@RequestParam(value = "category", required = false) String category,
                               @RequestParam(value = "page", defaultValue = "1") int page,
                               Model model, HttpSession session) {
    	
    	String userId = (String) session.getAttribute("userId");
        List<MenuVO> sidebarMenus = menuService.getMenusByPosition("sidebar");
        List<MenuVO> headerMenus = menuService.getMenusByPosition("header");
        List<MenuVO> menus = menuService.getAllMenus();
        model.addAttribute("menus", menus);
        model.addAttribute("sidebarMenus", sidebarMenus);
        model.addAttribute("headerMenus", headerMenus);
        String username = null;
        if (userId != null) {
            // ÏÇ¨Ïö©Ïûê IDÎ•º ÌÜµÌï¥ ÏÇ¨Ïö©Ïûê Ïù¥Î¶Ñ Í∞ÄÏ†∏Ïò§Í∏∞
            username = memberService.getUserByName(userId);
        }
        model.addAttribute("username", username);
        
        if (category != null && !category.isEmpty()) {
            int pageSize = 40; // 5 x 8 Ïπ¥Îìú Í∏∞Ï§Ä
            int offset = (page - 1) * pageSize;

            List<ProductBoardVO> products = menuService.getProductsByCategoryPaged(category, offset, pageSize);
            int totalCount = menuService.countProductsByCategory(category);
            int totalPages = (int) Math.ceil((double) totalCount / pageSize);

            model.addAttribute("products", products);
            model.addAttribute("selectedCategory", category);
            model.addAttribute("currentPage", page);
            model.addAttribute("totalPages", totalPages);
        } else {
            model.addAttribute("products", Collections.emptyList());
        }

        return "refresh/productboardlogin";
    }
    
    // Î°úÍ∑∏Ïù∏ Ï†Ñ ÎîîÌÖåÏùº
    @GetMapping("/detail/{id}")
    public String productDetail(@PathVariable("id") int productId,
					            @RequestParam(required = false) String category,
					            @RequestParam(defaultValue = "1") int page,
					            Model model) {

        ProductBoardVO product = productService.getProductById(productId);
        List<MenuVO> sidebarMenus = menuService.getMenusByPosition("sidebar");
        List<MenuVO> headerMenus = menuService.getMenusByPosition("header");

        int pageSize = 5;
        int offset = (page - 1) * pageSize;

        Map<String, Object> paramMap = new HashMap<>();
        paramMap.put("productId", productId);
        paramMap.put("offset", offset);
        paramMap.put("limit", pageSize);

        List<PReviewVO> reviews = productService.getPagedReviewsByProductId(paramMap);
        int totalCount = productService.getReviewCountByProductId(productId);
        int totalPages = (int) Math.ceil((double) totalCount / pageSize);

        // üî• Î¶¨Î∑∞ Ïù¥ÎØ∏ÏßÄ Î¶¨Ïä§Ìä∏ ÏÑ∏ÌåÖ
        for (PReviewVO review : reviews) {
            List<ReviewImageVO> images = productService.getImagesByReviewId((long) review.getReviewId());
            review.setImageList(images);
        }

        // üî• Ï∂îÍ∞Ä Ïù¥ÎØ∏ÏßÄ Î¶¨Ïä§Ìä∏
        List<ProductImageVO> additionalImages = pBoardDAO.getImagesByProductId(productId);
        model.addAttribute("additionalImages", additionalImages);

        // üî• ÏÉÅÏÑ∏ Ïù¥ÎØ∏ÏßÄ Î¶¨Ïä§Ìä∏
        List<String> detailImages = productService.getDetailImagesByProductId(productId);
        model.addAttribute("detailImages", detailImages);

        // üî• ÏÉÅÏÑ∏ ÏòµÏÖò Î¶¨Ïä§Ìä∏
        if (product.getDetailOption() != null) {
            List<String> options = Arrays.asList(product.getDetailOption().split(","));
            model.addAttribute("optionList", options);
        } else {
            model.addAttribute("optionList", null);
        }

        // üî• ÏÉÅÏÑ∏ ÏòµÏÖò Í∞ÄÍ≤© Î¶¨Ïä§Ìä∏
        if (product.getDetailOptionPrice() != null) {
            String[] priceStrArr = product.getDetailOptionPrice().split(",");
            List<Integer> optionPriceList = new ArrayList<>();
            for (String p : priceStrArr) {
                try {
                    optionPriceList.add(Integer.parseInt(p.trim()));
                } catch (NumberFormatException e) {
                    optionPriceList.add(0);
                }
            }
            model.addAttribute("optionPriceList", optionPriceList);
        } else {
            model.addAttribute("optionPriceList", null);
        }

        model.addAttribute("product", product);
        model.addAttribute("reviews", reviews);
        model.addAttribute("sidebarMenus", sidebarMenus);
        model.addAttribute("headerMenus", headerMenus);
        model.addAttribute("currentPage", page);
        model.addAttribute("totalPages", totalPages);
        model.addAttribute("category", category);

        return "refresh/detail";
    }

    @GetMapping("/detailL/{id}")
    public String productDetailLogin(@PathVariable("id") int productId,
                                     @RequestParam(required = false) String category,
                                     @RequestParam(defaultValue = "1") int page,
                                     Model model, HttpSession session) {

        String userId = (String) session.getAttribute("userId");
        String username = userId != null ? memberService.getUserByName(userId) : null;
        String userGrade = null;

        ProductBoardVO product = productService.getProductById(productId);
        List<MenuVO> sidebarMenus = menuService.getMenusByPosition("sidebar");
        List<MenuVO> headerMenus = menuService.getMenusByPosition("header");

        int pageSize = 5;
        int offset = (page - 1) * pageSize;

        Map<String, Object> paramMap = new HashMap<>();
        paramMap.put("productId", productId);
        paramMap.put("offset", offset);
        paramMap.put("limit", pageSize);

        List<PReviewVO> reviews = productService.getPagedReviewsByProductId(paramMap);
        int totalCount = productService.getReviewCountByProductId(productId);
        int totalPages = (int) Math.ceil((double) totalCount / pageSize);

        // üî• Î¶¨Î∑∞ Ïù¥ÎØ∏ÏßÄ Î¶¨Ïä§Ìä∏ ÏÑ∏ÌåÖ
        for (PReviewVO review : reviews) {
            List<ReviewImageVO> images = productService.getImagesByReviewId((long) review.getReviewId());
            review.setImageList(images);
        }

        if (userId != null) {
            MemberVO member = memberService.getUserById(userId);
            if (member != null) {
                userGrade = member.getGrade(); // ÎòêÎäî getUserGrade()
            }
        }
        
        // üî• Ï∂îÍ∞Ä Ïù¥ÎØ∏ÏßÄ Î¶¨Ïä§Ìä∏
        List<ProductImageVO> additionalImages = pBoardDAO.getImagesByProductId(productId);
        model.addAttribute("additionalImages", additionalImages);

        // üî• ÏÉÅÏÑ∏ Ïù¥ÎØ∏ÏßÄ Î¶¨Ïä§Ìä∏
        List<String> detailImages = productService.getDetailImagesByProductId(productId);
        model.addAttribute("detailImages", detailImages);

        // üî• ÏÉÅÏÑ∏ ÏòµÏÖò Î¶¨Ïä§Ìä∏
        if (product.getDetailOption() != null) {
            List<String> options = Arrays.asList(product.getDetailOption().split(","));
            model.addAttribute("optionList", options);
        } else {
            model.addAttribute("optionList", null);
        }

        // üî• ÏÉÅÏÑ∏ ÏòµÏÖò Í∞ÄÍ≤© Î¶¨Ïä§Ìä∏
        if (product.getDetailOptionPrice() != null) {
            String[] priceStrArr = product.getDetailOptionPrice().split(",");
            List<Integer> optionPriceList = new ArrayList<>();
            for (String p : priceStrArr) {
                try {
                    optionPriceList.add(Integer.parseInt(p.trim()));
                } catch (NumberFormatException e) {
                    optionPriceList.add(0);
                }
            }
            model.addAttribute("optionPriceList", optionPriceList);
        } else {
            model.addAttribute("optionPriceList", null);
        }

        model.addAttribute("userGrade", userGrade);
        model.addAttribute("username", username);
        model.addAttribute("product", product);
        model.addAttribute("reviews", reviews);
        model.addAttribute("sidebarMenus", sidebarMenus);
        model.addAttribute("headerMenus", headerMenus);
        model.addAttribute("currentPage", page);
        model.addAttribute("totalPages", totalPages);
        model.addAttribute("category", category);

        return "refresh/detailLogin";
    }
    
    @GetMapping("/main-image/{productId}")
    public ResponseEntity<byte[]> getMainImage(@PathVariable("productId") int productId) {
        ProductBoardVO product = productService.getProductById(productId);

        if (product == null || product.getImage() == null || product.getImage().length == 0) {
            return ResponseEntity.notFound().build();
        }

        String imageType = product.getImageType();
        MediaType mediaType;

        try {
            if (imageType == null || !imageType.startsWith("image/")) {
                mediaType = MediaType.IMAGE_JPEG;
            } else {
                if (imageType.equalsIgnoreCase("image/jpg")) {
                    imageType = "image/jpeg";
                }
                mediaType = MediaType.parseMediaType(imageType);
            }
        } catch (InvalidMimeTypeException e) {
            mediaType = MediaType.IMAGE_JPEG;
        }

        return ResponseEntity.ok()
                .contentType(mediaType)
                .cacheControl(CacheControl.maxAge(1, TimeUnit.HOURS).cachePublic())
                .body(product.getImage());
    }

    // Î©îÏù∏ Ï∂îÍ∞Ä Ïù¥ÎØ∏ÏßÄ
    @GetMapping("/detail-image/{productId}/{index}")
    public ResponseEntity<byte[]> getDetailImageByIndex(@PathVariable("productId") int productId,
                                                        @PathVariable("index") int index) {
        // üî• Ï†ÑÏ≤¥ Ïù¥ÎØ∏ÏßÄ ÎßêÍ≥†, Ìï¥Îãπ productIdÏùò Ïù¥ÎØ∏ÏßÄ Î¶¨Ïä§Ìä∏Îßå Í∞ÄÏ†∏Ïò¥
        List<ProductImageVO> imageList = pBoardDAO.getImagesByProductId(productId);

        if (imageList == null || imageList.size() <= index) {
            return ResponseEntity.notFound().build();
        }

        ProductImageVO imageVO = imageList.get(index);

        if (imageVO == null || imageVO.getImage() == null || imageVO.getImage().length == 0) {
            return ResponseEntity.notFound().build();
        }

        String imageType = imageVO.getImageType();
        MediaType mediaType;

        try {
            if (imageType == null || !imageType.startsWith("image/")) {
                mediaType = MediaType.IMAGE_JPEG;
            } else {
                if (imageType.equalsIgnoreCase("image/jpg")) {
                    imageType = "image/jpeg";
                }
                mediaType = MediaType.parseMediaType(imageType);
            }
        } catch (InvalidMimeTypeException e) {
            mediaType = MediaType.IMAGE_JPEG;
        }

        return ResponseEntity.ok()
                .contentType(mediaType)
                .cacheControl(CacheControl.maxAge(1, TimeUnit.HOURS).cachePublic())
                .body(imageVO.getImage());
    }
  
    // üî• ÎîîÌÖåÏùº Ïù¥ÎØ∏ÏßÄ Î†åÎçîÎßÅ
    @GetMapping("/detail-images/{productId}/{index}")
    public ResponseEntity<byte[]> getDetailImage(@PathVariable("productId") int productId,
                                                 @PathVariable("index") int index) {
        // ProductBoardVOÏóêÏÑú Ïù¥ÎØ∏ÏßÄ Î¶¨Ïä§Ìä∏ Í∞ÄÏ†∏Ïò§Í∏∞
        ProductBoardVO product = productService.getProductById(productId);
        if (product == null || product.getImages() == null || product.getImages().isEmpty()) {
            return ResponseEntity.notFound().build();
        }

        List<ProductImageVO> imageList = product.getImages(); // ProductBoardVOÏóê getImages() Ï°¥Ïû¨

        if (index < 0 || index >= imageList.size()) {
            return ResponseEntity.notFound().build();
        }

        ProductImageVO imageVO = imageList.get(index);
        if (imageVO == null || imageVO.getImage() == null || imageVO.getImage().length == 0) {
            return ResponseEntity.notFound().build();
        }

        String imageType = imageVO.getImageType();
        MediaType mediaType;
        try {
            if (imageType == null || !imageType.startsWith("image/")) {
                mediaType = MediaType.IMAGE_JPEG;
            } else {
                if (imageType.equalsIgnoreCase("image/jpg")) {
                    imageType = "image/jpeg";
                }
                mediaType = MediaType.parseMediaType(imageType);
            }
        } catch (InvalidMimeTypeException e) {
            mediaType = MediaType.IMAGE_JPEG;
        }

        return ResponseEntity.ok()
                .contentType(mediaType)
                .cacheControl(CacheControl.maxAge(1, TimeUnit.HOURS).cachePublic())
                .body(imageVO.getImage());
    }

    @GetMapping("/review-image/{reviewId}/{index}")
    public ResponseEntity<byte[]> getReviewImage(@PathVariable("reviewId") Long reviewId,
                                                 @PathVariable("index") int index) {
        List<ReviewImageVO> imageList = productService.getImagesByReviewId(reviewId);
        if (imageList == null || imageList.isEmpty() || index < 0 || index >= imageList.size()) {
            return ResponseEntity.notFound().build();
        }

        ReviewImageVO imageVO = imageList.get(index);
        if (imageVO == null || imageVO.getImageData() == null || imageVO.getImageData().length == 0) {
            return ResponseEntity.notFound().build();
        }

        String name = imageVO.getImageName();
        String imageType = "image/jpeg";
        if (name != null && name.contains(".")) {
            String ext = name.substring(name.lastIndexOf('.') + 1).toLowerCase();
            switch (ext) {
                case "png": imageType = "image/png"; break;
                case "gif": imageType = "image/gif"; break;
                case "jpg": case "jpeg": imageType = "image/jpeg"; break;
                case "webp": imageType = "image/webp"; break;
            }
        }

        return ResponseEntity.ok()
                .contentType(MediaType.parseMediaType(imageType))
                .cacheControl(CacheControl.noCache())
                .body(imageVO.getImageData());
    }
    
    // Î°úÍ∑∏Ïù∏Ï†Ñ ÏÉÅÌíà Í≤ÄÏÉâ
    @GetMapping("/search")
    public String searchProducts(@RequestParam("keyword") String keyword, Model model) {
        List<ProductBoardVO> products = productService.searchProducts(keyword);
        List<MenuVO> sidebarMenus = menuService.getMenusByPosition("sidebar");
        List<MenuVO> headerMenus = menuService.getMenusByPosition("header");
        
        model.addAttribute("sidebarMenus", sidebarMenus);
        model.addAttribute("headerMenus", headerMenus);
        model.addAttribute("products", products);
        model.addAttribute("keyword", keyword);
        return "refresh/psearch";  // Í≤ÄÏÉâ Í≤∞Í≥ºÎ•º Î≥¥Ïó¨Ï§Ñ Î∑∞ Ïù¥Î¶Ñ
    }
    
    // Î°úÍ∑∏Ïù∏ÌõÑ ÏÉÅÌíà Í≤ÄÏÉâ
    @GetMapping("/searchL")
    public String searchProductsLogin(@RequestParam("keyword") String keyword, Model model, HttpSession session) {
    	String userId = (String) session.getAttribute("userId");
        List<ProductBoardVO> products = productService.searchProducts(keyword);
        List<MenuVO> sidebarMenus = menuService.getMenusByPosition("sidebar");
        List<MenuVO> headerMenus = menuService.getMenusByPosition("header");
        String username = null;
        if (userId != null) {
            // ÏÇ¨Ïö©Ïûê IDÎ•º ÌÜµÌï¥ ÏÇ¨Ïö©Ïûê Ïù¥Î¶Ñ Í∞ÄÏ†∏Ïò§Í∏∞
            username = memberService.getUserByName(userId);
        }
        model.addAttribute("username", username);
        
        model.addAttribute("sidebarMenus", sidebarMenus);
        model.addAttribute("headerMenus", headerMenus);
        model.addAttribute("products", products);
        model.addAttribute("keyword", keyword);
        return "refresh/psearchlogin";  // Í≤ÄÏÉâ Í≤∞Í≥ºÎ•º Î≥¥Ïó¨Ï§Ñ Î∑∞ Ïù¥Î¶Ñ
    }
    
    // ÎπÑÌöåÏõê Íµ¨Îß§
    @GetMapping("/purchase")
    public String purchase(Model model) {
    	List<MenuVO> sidebarMenus = menuService.getMenusByPosition("sidebar");
        List<MenuVO> headerMenus = menuService.getMenusByPosition("header");
        
        model.addAttribute("sidebarMenus", sidebarMenus);
        model.addAttribute("headerMenus", headerMenus);
    	return "refresh/purchase";
    }
    
    @GetMapping("/purchaseL")
    public String purchaselogin(Model model, HttpSession session) {
        List<MenuVO> sidebarMenus = menuService.getMenusByPosition("sidebar");
        List<MenuVO> headerMenus = menuService.getMenusByPosition("header");

        String userId = (String) session.getAttribute("userId");
        String username = null;
        List<MemberBenefit> benefits = new ArrayList<>();

        if (userId != null) {
            username = memberService.getUserByName(userId);
            benefits = memberService.getBenefits(userId); // ÌòúÌÉù Ï°∞Ìöå
        }
        if (userId != null) {
            username = memberService.getUserByName(userId);
            benefits = memberService.getBenefits(userId);
            MemberVO memberInfo = memberService.getUserById(userId); // Ìè¨Ïù∏Ìä∏ Ìè¨Ìï®Îêú Í∞ùÏ≤¥
            model.addAttribute("memberInfo", memberInfo);
        }

        model.addAttribute("userId", userId);
        model.addAttribute("username", username);
        model.addAttribute("benefits", benefits); // ÌòúÌÉù Ï∂îÍ∞Ä
        model.addAttribute("sidebarMenus", sidebarMenus);
        model.addAttribute("headerMenus", headerMenus);

        return "refresh/purchaselogin";
    }
    
    @GetMapping("/user-info")
    public ResponseEntity<Map<String, String>> getUserInfo(HttpSession session) {
        String userId = (String) session.getAttribute("userId");
        if (userId == null) {
            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();
        }

        MemberVO member = memberService.getUserById(userId);

        if (member == null) {
            return ResponseEntity.status(HttpStatus.NOT_FOUND).build();
        }

        Map<String, String> info = new HashMap<>();
        info.put("customerId", member.getId());  // Ï∂îÍ∞Ä
        info.put("name", member.getName());
        info.put("email", member.getEmail());
        info.put("phone", member.getPhoneNumber());
        info.put("address", member.getAddress());

        return ResponseEntity.ok(info);
    }

    @PostMapping("/order")
    @ResponseBody
    public String guestOrderSubmit(
            @RequestParam(required = false) String customerId,
            @RequestParam String customerName,
            @RequestParam String email,
            @RequestParam String phoneNumber,
            @RequestParam String shippingAddress,
            @RequestParam String deliveryRequest,
            @RequestParam String paymentMethod,
            @RequestParam String cartData,
            @RequestParam(required = false) String usedBenefits,
            @RequestParam(required = false, defaultValue = "0") int usedPoint) {

        // ÎπÑÌöåÏõê Ï£ºÎ¨∏ Ïãú customerIdÎ•º nullÎ°ú ÏÑ§Ï†ï
        if (customerId == null || customerId.trim().isEmpty()) {
            customerId = null;
        }

        ObjectMapper mapper = new ObjectMapper();
        List<CartItem> cart = null;
        try {
            cart = mapper.readValue(cartData, new TypeReference<List<CartItem>>() {});
        } catch (Exception e) {
            return "<script>alert('Ïû•Î∞îÍµ¨Îãà Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨ Ïò§Î•ò'); window.location='/midnav/cart';</script>";
        }

        if (cart == null || cart.isEmpty()) {
            return "<script>alert('Ïû•Î∞îÍµ¨ÎãàÍ∞Ä ÎπÑÏñ¥ÏûàÏäµÎãàÎã§.'); window.location='/midnav/cart';</script>";
        }

        if (usedPoint > 0 && customerId != null) {
            MemberVO member = memberService.getUserById(customerId); // Í∏∞Ï°¥ Î©îÏÑúÎìú ÌôúÏö©
            int currentPoint = member.getPoint(); // Ìè¨Ïù∏Ìä∏ Ï°∞Ìöå

            if (usedPoint <= currentPoint) {
                memberService.usePoint(customerId, usedPoint); // Ìè¨Ïù∏Ìä∏ Ï∞®Í∞ê
            } else {
                System.err.println("Ìè¨Ïù∏Ìä∏ Ï∞®Í∞ê Ïã§Ìå®: Î≥¥Ïú† Ìè¨Ïù∏Ìä∏ Ï¥àÍ≥º");
            }
        }
        
        String productId = cart.stream()
                .map(item -> String.valueOf(item.getProductId()))
                .collect(Collectors.joining(","));

        String quantities = cart.stream()
                .map(item -> String.valueOf(item.getQuantity()))
                .collect(Collectors.joining(","));

        String detailOption = cart.stream()
                .map(item -> (item.getOption() != null && !item.getOption().trim().isEmpty()) ? item.getOption() : "ÏóÜÏùå")
                .collect(Collectors.joining(","));

        int totalQuantity = cart.stream().mapToInt(CartItem::getQuantity).sum();
        int sumTotalPrice = cart.stream().mapToInt(item -> item.getQuantity() * item.getPrice()).sum();

        OrderVO order = new OrderVO();
        order.setCustomerId(customerId);
        order.setCustomerName(customerName);
        order.setEmail(email);
        order.setPhoneNumber(phoneNumber);
        order.setShippingAddress(shippingAddress);
        order.setDeliveryRequest(deliveryRequest);
        order.setPaymentMethod(paymentMethod);
        order.setProductId(productId);
        order.setProductQuantities(quantities);
        order.setDetailOption(detailOption);
        order.setQuantity(totalQuantity);
        order.setTotalPrice(sumTotalPrice);

        productService.placeGuestOrder(order);

        // ‚úÖ ÏÇ¨Ïö©Îêú Ïø†Ìè∞ ÏÇ≠Ï†ú Ï≤òÎ¶¨
        if (usedBenefits != null && customerId != null) {
            try {
                List<String> benefitsToRemove = mapper.readValue(usedBenefits, new TypeReference<List<String>>() {});
                memberService.deleteBenefits(customerId, benefitsToRemove);
            } catch (Exception e) {
                System.err.println("Ïø†Ìè∞ ÏÇ≠Ï†ú Ïã§Ìå®: " + e.getMessage());
            }
        }

        return "<script>alert('Íµ¨Îß§Í∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§! Í∞êÏÇ¨Ìï©ÎãàÎã§!'); window.location='/home';</script>";
    }
    
    @GetMapping("/createreview/{id}")
    public String createReview (@PathVariable("id") int productId,
		            @RequestParam(required = false) String category,
		            @RequestParam(defaultValue = "1") int page,
		            Model model, HttpSession session) {
		
		String userId = (String) session.getAttribute("userId");
		String username = userId != null ? memberService.getUserByName(userId) : null;
		
		ProductBoardVO product = productService.getProductById(productId);
		List<MenuVO> sidebarMenus = menuService.getMenusByPosition("sidebar");
		List<MenuVO> headerMenus = menuService.getMenusByPosition("header");
		
		int pageSize = 5;
		int offset = (page - 1) * pageSize;
		
		Map<String, Object> paramMap = new HashMap<>();
		paramMap.put("productId", productId);
		paramMap.put("offset", offset);
		paramMap.put("limit", pageSize);
		
		List<PReviewVO> reviews = productService.getPagedReviewsByProductId(paramMap);
		int totalCount = productService.getReviewCountByProductId(productId);
		int totalPages = (int) Math.ceil((double) totalCount / pageSize);
		
		// üî• Î¶¨Î∑∞ Ïù¥ÎØ∏ÏßÄ Î¶¨Ïä§Ìä∏ ÏÑ∏ÌåÖ
		for (PReviewVO review : reviews) {
		    List<ReviewImageVO> images = productService.getImagesByReviewId((long) review.getReviewId());
		    review.setImageList(images); 
		    System.out.println("reviewId=" + review.getReviewId() + ", imageCount=" + (images != null ? images.size() : 0));
		}
		
		// üî• Ï∂îÍ∞Ä Ïù¥ÎØ∏ÏßÄ Î¶¨Ïä§Ìä∏
		List<ProductImageVO> additionalImages = pBoardDAO.getImagesByProductId(productId);
		model.addAttribute("additionalImages", additionalImages);
		
		// üî• ÏÉÅÏÑ∏ Ïù¥ÎØ∏ÏßÄ Î¶¨Ïä§Ìä∏
		List<String> detailImages = productService.getDetailImagesByProductId(productId);
		model.addAttribute("detailImages", detailImages);
		
		// üî• ÏÉÅÏÑ∏ ÏòµÏÖò Î¶¨Ïä§Ìä∏
		if (product.getDetailOption() != null) {
		List<String> options = Arrays.asList(product.getDetailOption().split(","));
		model.addAttribute("optionList", options);
		} else {
		model.addAttribute("optionList", null);
		}
		
		// üî• ÏÉÅÏÑ∏ ÏòµÏÖò Í∞ÄÍ≤© Î¶¨Ïä§Ìä∏
		if (product.getDetailOptionPrice() != null) {
		String[] priceStrArr = product.getDetailOptionPrice().split(",");
		List<Integer> optionPriceList = new ArrayList<>();
		for (String p : priceStrArr) {
		try {
		optionPriceList.add(Integer.parseInt(p.trim()));
		} catch (NumberFormatException e) {
		optionPriceList.add(0);
		}
		}
		model.addAttribute("optionPriceList", optionPriceList);
		} else {
		model.addAttribute("optionPriceList", null);
		}
		
		model.addAttribute("username", username);
		model.addAttribute("product", product);
		model.addAttribute("reviews", reviews);
		model.addAttribute("sidebarMenus", sidebarMenus);
		model.addAttribute("headerMenus", headerMenus);
		model.addAttribute("currentPage", page);
		model.addAttribute("totalPages", totalPages);
		model.addAttribute("category", category);
		
    	return "refresh/createreview";
    }
    
    @PostMapping("/createreview")
    public String createReview(@ModelAttribute PReviewVO review,
                               @RequestParam("reviewImages") MultipartFile[] files,
                               HttpSession session, Model model) throws IOException {
        String userId = (String) session.getAttribute("userId");
        String userName = userId != null ? memberService.getUserByName(userId) : null;

        review.setUserId(userId);
        review.setUserName(userName);

        // MultipartFile -> ReviewImageVO Î¶¨Ïä§Ìä∏ Î≥ÄÌôò
        List<ReviewImageVO> imageList = new ArrayList<>();
        for (MultipartFile file : files) {
            if (!file.isEmpty()) {
                ReviewImageVO img = new ReviewImageVO();
                img.setImageName(file.getOriginalFilename());
                img.setImageData(file.getBytes());
                img.setUploadDate(new Timestamp(System.currentTimeMillis()));
                imageList.add(img);
            }
        }

        // ÏÑúÎπÑÏä§ Ìò∏Ï∂ú (ÏÑúÎπÑÏä§ÏóêÏÑú reviewId ÏÑ∏ÌåÖ ÌõÑ Ïù¥ÎØ∏ÏßÄ reviewIdÎèÑ ÏÑ∏ÌåÖÎê®)
        productService.insertReviewWithImages(review, imageList);
        model.addAttribute("userName", userName);

        return "redirect:/products/detailL/" + review.getProductId();
    }
    
    @PostMapping("/review/delete")
    public String deleteReview(@RequestParam Long reviewId,
                               @RequestParam int productId,
                               HttpSession session,
                               RedirectAttributes redirectAttributes) {

        String userId = (String) session.getAttribute("userId");

        if (userId == null) {
            redirectAttributes.addFlashAttribute("error", "Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.");
            return "redirect:/login";
        }

        PReviewVO review = productService.getReviewById(reviewId);
        if (review == null) {
            redirectAttributes.addFlashAttribute("error", "Î¶¨Î∑∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");
            return "redirect:/products/detailL/" + productId;
        }

        MemberVO member = memberService.getUserById(userId);
        String grade = member != null ? member.getGrade() : null;

        boolean isOwner = userId.equals(review.getUserId());
        boolean isAuthorized = grade != null && List.of("Ïö¥ÏòÅÏûê", "ÏÇ¨Ïõê", "Îß§ÎãàÏ†Ä").contains(grade);

        if (isOwner || isAuthorized) {
            productService.deleteReview(reviewId, userId, grade);
            redirectAttributes.addFlashAttribute("alertMessage", "ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§!");
        } else {
            redirectAttributes.addFlashAttribute("alertMessage", "ÏÇ≠Ï†ú Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§.");
        }

        return "redirect:/products/detailL/" + productId;
    }
    
    @PostMapping("/review/update")
    public String updateReview(@RequestParam("reviewId") Long reviewId,
                               @RequestParam("productId") Long productId,
                               @RequestParam("reviewComment") String reviewComment,
                               @RequestParam(value = "newImages", required = false) MultipartFile[] newImages,
                               HttpSession session,
                               RedirectAttributes redirectAttributes) {

        // 1. Î°úÍ∑∏Ïù∏Îêú ÏÇ¨Ïö©Ïûê ID ÌôïÏù∏
        String userId = (String) session.getAttribute("userId");
        if (userId == null) {
            redirectAttributes.addFlashAttribute("error", "Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.");
            return "redirect:/login";
        }

        // 2. Î¶¨Î∑∞ Ï†ïÎ≥¥ Ï°∞Ìöå
        PReviewVO review = productService.getReviewById(reviewId);
        if (review == null) {
            redirectAttributes.addFlashAttribute("error", "Î¶¨Î∑∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");
            return "redirect:/products/detailL/" + productId;
        }

        // 3. ÌöåÏõê Îì±Í∏â Ï°∞Ìöå
        MemberVO member = memberService.getUserById(userId);
        String grade = member != null ? member.getGrade() : null;

        // 4. Í∂åÌïú Ï≤¥ÌÅ¨
        boolean isOwner = userId.equals(review.getUserId());
        boolean isAuthorized = grade != null && List.of("Ïö¥ÏòÅÏûê", "ÏÇ¨Ïõê", "Îß§ÎãàÏ†Ä").contains(grade);

        if (isOwner || isAuthorized) {
            productService.updateReview(reviewId, productId, reviewComment, newImages);
            redirectAttributes.addFlashAttribute("alertMessage", "ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§!");
        } else {
            redirectAttributes.addFlashAttribute("alertMessage", "ÏûêÍ∏∞ÏûêÏã†Ïùò Î¶¨Î∑∞Îßå ÏàòÏ†ïÌï† Ïàò ÏûàÏäµÎãàÎã§!");
        }

        return "redirect:/products/detailL/" + productId;
    }

}
