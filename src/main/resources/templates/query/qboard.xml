<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.refresh.board.dao.QBoardDAO">
	<insert id="insertConsultationRequest" parameterType="qboard">
	        INSERT INTO requests (
	            consultant_name,
	            consultant_email,
	            consultation_type,
	            consultant_password,
	            consultant_message,
	            member_id
	        ) VALUES (
	            #{consultantName},
	            #{consultantEmail},
	            #{consultationType},
	            #{consultantPassword},
	            #{consultantMessage},
	           	#{memberId}
	        )
    </insert>
    
    <!-- 게시물 리스트 -->
    <select id="getPosts" resultType="board">
        SELECT *
	    FROM posts
	    WHERE title LIKE '%' || #{keyword, jdbcType=VARCHAR} || '%'
	    ORDER BY post_id DESC
	    OFFSET #{offset} ROWS FETCH NEXT #{size} ROWS ONLY
    </select>
    
    <!-- 게시글 총 개수 조회 (검색 조건 포함) -->
    <select id="getTotalPostCount" resultType="int">
        SELECT COUNT(*)
    	FROM posts
    	WHERE title LIKE '%' || #{keyword, jdbcType=VARCHAR} || '%'
    </select>
    
    <!-- 게시물 상세 조회 -->
    <select id="getPostById" resultType="board">
        SELECT POST_ID, TITLE, CONTENT, MEMBER_ID, CREATED_DATE, UPDATED_DATE, VIEW_COUNT, BOARD_TYPE, IMAGE
        FROM POSTS
        WHERE POST_ID = #{postId}
    </select>
    
    <delete id="deletePost">
    	DELETE FROM posts WHERE post_id = #{postId}
	</delete>
	
	<select id="getPostByIdDelete" resultType="board">
	    SELECT *
	    FROM posts
	    WHERE post_id = #{postId}
	</select>
    
    <!-- 댓글 목록 조회 (특정 게시글) -->
    <select id="selectCommentsByPostIdPaged" resultType="comment">
	    <![CDATA[
	    SELECT *
	    FROM (
	        SELECT inner.*, ROWNUM rn
	        FROM (
	            SELECT * 
	            FROM comments 
	            WHERE post_id = #{postId}
	            ORDER BY created_date DESC
	        ) inner
	        WHERE ROWNUM <= #{endRow}
	    )
	    WHERE rn > #{startRow}
	    ]]>
	</select>
    
    <select id="countCommentsByPostId" resultType="int">
	    SELECT COUNT(*) FROM comments WHERE post_id = #{postId}
	</select>
    
    <!-- 다건 조회 (회원 아이디로 상담 내역 전체 조회) -->
	<select id="getRequestsByMemberId" parameterType="String" resultType="qboard">
	    SELECT *
	    FROM REQUESTS
	    WHERE MEMBER_ID = #{member_id}
	    ORDER BY REQUEST_DATE DESC
	</select>
	
	<select id="selectCommentById" resultType="comment">
        SELECT * FROM comments WHERE comment_id = #{commentId}
    </select>

    <update id="updateComment">
        UPDATE comments
        SET content = #{content},
            updated_date = #{updatedDate}
        WHERE comment_id = #{commentId}
    </update>

    <delete id="deleteComment">
        DELETE FROM comments WHERE comment_id = #{commentId}
    </delete>
</mapper>